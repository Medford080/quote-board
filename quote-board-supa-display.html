<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://ojwukbzdmvnkapfsvilt.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qd3VrYnpkbXZua2FwZnN2aWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNjAwNDUsImV4cCI6MjA3NjkzNjA0NX0.LAOfKFxBoySyRIZRl0aGqslMvatlVkou3fwCN1oefKA";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function loadQuotesOnce() {
    const { data, error } = await supabase
      .from("quotes")
      .select("text, author, image_url")
      .order("created_at", { ascending: true });
    if (error) { console.warn(error); return; }

    const arr = (data || []).map(q => ({
      text: q.text || "",
      author: q.author || "",
      image: q.image_url || ""
    })).filter(q => q.text);

    // ðŸ”´ If your main code hasn't exposed these, the next lines won't work.
    window.state.quotes = arr.length ? arr : window.state.quotes;
    window.state.index  = Math.min(window.state.index, Math.max(0, window.state.quotes.length - 1));
    window.saveState(); window.updateStage(); window.renderList();
  }

  function subscribeRealtime() {
    supabase
      .channel('quotes-realtime')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'quotes' }, loadQuotesOnce)
      .subscribe();
  }

  // Wait until the page & your main script have initialized
  window.addEventListener('load', async () => {
    await loadQuotesOnce();
    subscribeRealtime();
  });
</script>
